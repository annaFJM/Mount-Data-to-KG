## 📋 完整工作流程示例

### **第一层分类（1_material_type.py）**

```
材料数据 → Neo4j查询 → 动态生成任务描述 → API分类 → 自动纠错
```

**详细流程：**
1. **读取材料数据**：从JSON文件读取高熵合金数据
2. **连接Neo4j**：使用已知的"材料"节点 elementId: `4:bf9f3e2f-61c2-430f-be08-580850049dc8:0`
3. **查询子类**：`MATCH (a)-[r]->(b) WHERE elementId(a) = '4:...:0' RETURN b.name, elementId(b)`
   - 得到：金属材料、无机非金属材料、有机高分子材料等
4. **查询每个子类的例子**（最多10个）：对每个子类用其 elementId 查询
5. **调用API生成任务描述**：
   ```
   输入：父类="材料", 子类列表=["金属材料", "无机非金属材料"...]
   输出："你的任务是判断给定的材料具体属于哪个材料类型。"
   ```
6. **构建System Prompt**：
   ```
   材料知识图谱是一个管理了各种材料的层次逻辑关系的树，你是这个智能图谱的节点挂载器。
   
   你的任务是判断给定的材料具体属于哪个材料类型。
   
   - 金属材料
     例子：钢铁, 有色金属材料, 金属功能材料...
   - 无机非金属材料
     例子：...
   ```
7. **API分类**：返回 "金属材料"
8. **验证**：✅ "金属材料" 在候选列表中 → 分类成功
9. **保存 elementId**：记录"金属材料"的 elementId 用于下一层

---

### **第二层分类（2_metal_material_type.py）**

```
使用第一层的elementId → 查询金属材料子类 → 动态任务描述 → API分类 → 纠错
```

**详细流程：**
1. **使用第一层结果**：金属材料的 elementId（从第一层获得）
2. **查询金属材料的子类**：`MATCH (a)-[r]->(b) WHERE elementId(a) = '...' RETURN b.name, elementId(b)`
   - 得到：钢铁、有色金属材料、金属功能材料、特殊用途金属材料、粉末冶金材料
3. **为每个子类查询例子**（有向边，最多10个）
4. **动态生成任务描述**
5. **构建System Prompt**（包含子类型描述和例子）
6. **API分类**：第一次可能返回 "高熵合金"
7. **验证失败** ⚠️：不在候选列表中
8. **自动纠正**：
   ```
   你的回答"高熵合金"不在候选列表中。
   候选列表只有：钢铁, 有色金属材料...
   请必须从上述列表中选择。
   ```
9. **第二次API调用**：返回 "特殊用途金属材料"
10. **验证通过** ✅
11. **保存 elementId**：记录"特殊用途金属材料"的 elementId 用于第三层

---

### **第三层分类（3_special_purpose_metal_type.py）** ⭐ 新特性

```
三层完整分类 + 无向边查询例子
```

**详细流程：**
1. **执行第一层分类**
2. **执行第二层分类**
3. **第三层查询**：使用"特殊用途金属材料"的 elementId
4. **查询子类**（有向边）：
   ```cypher
   MATCH (a)-[r]->(b)
   WHERE elementId(a) = '特殊用途金属材料的elementId'
   RETURN b.name, elementId(b)
   ```
   - 得到：耐磨金属材料、耐蚀合金、金属间化合物、高温合金、高熵合金
   
5. **查询例子**（**⚠️ 无向边！**）：
   ```cypher
   MATCH (a)-[r]-(b)  ← 注意这里是无向边！
   WHERE elementId(a) = '高熵合金的elementId'
   RETURN b.name
   LIMIT 10
   ```
   
6. **动态生成任务描述**
7. **API分类 + 自动纠错**
8. **输出完整分类路径**：
   ```
   材料 → 金属材料 → 特殊用途金属材料 → 高熵合金
   ```

---

## 🔑 关键特性总结

| 特性 | 实现方式 |
|------|---------|
| **唯一标识** | 使用 `elementId` 而非 `name` |
| **动态任务描述** | 每层调用API生成任务描述 |
| **限制例子数量** | 最多10个例子 |
| **自动纠错** | 最多重试3次，保持对话上下文 |
| **第三层特殊处理** | 查询例子时使用无向边 `-[r]-` |
| **逐层传递** | 每层保存 elementId 传给下一层 |